---
- name: Template config file to allow for remote access
  template:
    src: templates/50-server-cnf
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
    force: yes

- name: Start MariaDB service
  shell: mysqld_safe --skip-networking &

- name: Wait for MariaDB to start
  command: mysqladmin ping -u root -p"{{ database.root_password }}" -h localhost
  register: result
  until: result.rc == 0
  retries: 30
  delay: 10

- name: Create MySQL database
  community.mysql.mysql_db:
    login_user: root
    login_password: "{{ database.root_password }}"
    name: "{{ database.name }}"
    state: present

- name: Check if database exists
  shell: mysql -u root -p'{{ database.root_password }}' -e "SHOW DATABASES LIKE '{{ database.name }}';"
  register: db_result
  ignore_errors: True

- name: Display result
  debug: 
    msg: "Database {{ database.name }} exists"
  when: "database.name in db_result.stdout"

- name: Display result
  debug: 
    msg: "Database {{ database.name }} does not exist"
  when: "database.name not in db_result.stdout"

- name: Create MySQL user and grant all privileges on the database
  community.mysql.mysql_user:
    login_user: root
    login_password: "{{ database.root_password }}"
    name: "{{ database.user }}"
    password: "{{ database.user_password }}"
    host: "%"
    priv: "{{ database.name }}.*:ALL"
    state: present

- name: Stop mariadb 
  shell: mysqladmin -u root -p"{{ database.root_password }}" shutdown

# - name: Template config file for galera 
#  template:
#    src: templates/60-galera.j2
#    dest: /etc/mysql/mariadb.conf.d/60-galera.cnf
